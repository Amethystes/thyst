<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Amethyst</title>
  <meta name="description" content="Amethyst" />
  <meta name="theme-color" content="#9E49B3"/>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{

      --bgA:#050112;
      --bgB:#08021b;
      --bgC:#120433;
      --bgAngle: 180deg;

      --accent1:#c88bff;
      --accent2:#a86cff;
      --accent3:#8c4cff;

      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);

      --blur: 18px;
      --sat: 185%;
      --ease: cubic-bezier(.18,.98,.22,1);
      --speed: 240ms;

      --glow: 1;
      --motion: 1;

      --mx: 50vw;
      --my: 50vh;

      --gridOpacity: .48;
      --cursorGlow: .90;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      overflow:hidden;

      background:
        radial-gradient(980px 650px at 18% 84%, color-mix(in srgb, var(--accent1) 38%, transparent), transparent 62%),
        radial-gradient(900px 600px at 78% 26%, color-mix(in srgb, var(--accent2) 26%, transparent), transparent 62%),
        radial-gradient(1000px 650px at 55% 12%, color-mix(in srgb, var(--accent3) 18%, transparent), transparent 66%),
        linear-gradient(var(--bgAngle), var(--bgA), var(--bgB) 55%, var(--bgC));
    }

    .grid{
      position:fixed; inset:0; pointer-events:none;
      opacity: var(--gridOpacity);
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,.10) 0px, rgba(255,255,255,.10) 1px, transparent 1px, transparent 72px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,.10) 0px, rgba(255,255,255,.10) 1px, transparent 1px, transparent 72px);
      mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,.95), rgba(0,0,0,.55) 55%, rgba(0,0,0,0) 78%);
      z-index: 0;
    }
    .grid::after{
      content:"";
      position:absolute; inset:0;
      opacity:.34;
      background:
        radial-gradient(1200px 700px at 50% 45%, color-mix(in srgb, var(--accent1) 30%, transparent), transparent 65%),
        radial-gradient(1000px 600px at 72% 35%, color-mix(in srgb, var(--accent2) 22%, transparent), transparent 70%),
        radial-gradient(1000px 700px at 35% 70%, color-mix(in srgb, var(--accent3) 18%, transparent), transparent 70%);
      filter: blur(16px) saturate(165%);
    }

    .cursorGlow{
      position:fixed; inset:0; pointer-events:none;
      opacity: var(--cursorGlow);
      background:
        radial-gradient(420px 420px at var(--mx) var(--my), color-mix(in srgb, var(--accent1) 30%, transparent), transparent 60%),
        radial-gradient(640px 640px at var(--mx) var(--my), color-mix(in srgb, var(--accent2) 18%, transparent), transparent 70%);
      filter: blur(10px) saturate(190%);
      z-index: 1;
    }

    .grain{
      position:fixed; inset:0; pointer-events:none;
      opacity:.10;
      mix-blend-mode: overlay;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      background-size: 240px 240px;
      z-index: 2;
    }

    #particles{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 3;
      opacity: .85;
      display:none;
    }

    .hamburger{
      position:fixed; top: 18px; left: 18px;
      width: 46px; height: 46px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.13), rgba(255,255,255,.07));
      backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      -webkit-backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      box-shadow: 0 18px 48px rgba(0,0,0,.38), 0 0 calc(54px * var(--glow)) color-mix(in srgb, var(--accent1) 16%, transparent);
      cursor:pointer;
      z-index: 90;
      display:grid;
      place-items:center;
      user-select:none;
      overflow:hidden;
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease), background var(--speed) var(--ease);
    }
    .hamburger::before{
      content:"";
      position:absolute; inset:-60%;
      background: conic-gradient(from 120deg,
        color-mix(in srgb, var(--accent1) 42%, transparent),
        color-mix(in srgb, var(--accent2) 22%, transparent),
        color-mix(in srgb, var(--accent3) 18%, transparent),
        color-mix(in srgb, var(--accent1) 42%, transparent)
      );
      filter: blur(18px);
      opacity:.60;
      transition: opacity var(--speed) var(--ease);
      pointer-events:none;
    }
    .hamburger:hover{
      transform: translateY(-1px) scale(1.02);
      border-color: color-mix(in srgb, var(--accent1) 38%, var(--stroke));
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent1) 18%, rgba(255,255,255,.13)), rgba(255,255,255,.07));
    }
    .hamburger:hover::before{ opacity:.80; }

    .hamburger .lines{ width: 20px; height: 14px; display:flex; flex-direction:column; justify-content:space-between; position:relative; z-index:2; }
    .hamburger .lines span{
      height: 2px; border-radius: 99px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 0 18px color-mix(in srgb, var(--accent1) 20%, transparent);
      transition: transform 260ms var(--ease), opacity 260ms var(--ease), width 260ms var(--ease);
      transform-origin: left center;
    }
    body.menuOpen .hamburger .lines span:nth-child(1){ transform: translateY(6px) rotate(45deg); width: 22px; }
    body.menuOpen .hamburger .lines span:nth-child(2){ opacity: 0; transform: translateX(-6px); }
    body.menuOpen .hamburger .lines span:nth-child(3){ transform: translateY(-6px) rotate(-45deg); width: 22px; }

    .scrim{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      opacity:0; pointer-events:none;
      transition: opacity var(--speed) var(--ease);
      z-index: 70;
    }
    .drawer{
      position:fixed; top: 14px; left: 14px;
      width: 320px; height: calc(100vh - 28px);
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.13), rgba(255,255,255,.06));
      backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      -webkit-backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      box-shadow: 0 28px 90px rgba(0,0,0,.55), 0 0 calc(90px * var(--glow)) color-mix(in srgb, var(--accent1) 12%, transparent);
      transform: translateX(-112%) scale(.98);
      opacity: 0;
      transition: transform 260ms var(--ease), opacity var(--speed) var(--ease);
      z-index: 75;
      overflow:hidden;
    }
    .drawer::before{
      content:"";
      position:absolute; inset:-60%;
      background: conic-gradient(from 120deg,
        color-mix(in srgb, var(--accent1) 28%, transparent),
        color-mix(in srgb, var(--accent2) 18%, transparent),
        color-mix(in srgb, var(--accent3) 16%, transparent),
        color-mix(in srgb, var(--accent1) 28%, transparent)
      );
      filter: blur(22px);
      opacity:.55;
      pointer-events:none;
    }
    body.menuOpen .scrim{ opacity:1; pointer-events:auto; }
    body.menuOpen .drawer{ transform: translateX(0) scale(1); opacity: 1; }

    .drawerInner{ position:relative; height:100%; padding: 14px; display:flex; flex-direction:column; gap: 12px; }
    .drawerTop{ display:flex; align-items:center; justify-content:space-between; padding: 10px 10px 12px; border-bottom: 1px solid rgba(255,255,255,.10); }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand strong{ font-size: 13px; letter-spacing:.2px; }
    .brand span{ font-size: 12px; color: rgba(255,255,255,.68); }

    .close{
      height: 36px; padding: 0 12px; border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.10);
      color: rgba(255,255,255,.88);
      cursor:pointer;
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease), background var(--speed) var(--ease);
      user-select:none;
    }
    .close:hover{
      transform: translateY(-1px) rotate(-2deg) scale(1.02);
      border-color: color-mix(in srgb, var(--accent1) 34%, var(--stroke));
      background: color-mix(in srgb, var(--accent1) 14%, rgba(0,0,0,.10));
    }

    .nav{ display:flex; flex-direction:column; gap: 10px; padding-top: 6px; }
    .navItem{
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 12px;
      cursor:pointer;
      opacity:0;
      transform: translateY(12px) scale(.985);
      filter: blur(8px);
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease), background var(--speed) var(--ease);
      user-select:none;
    }
    body.menuOpen .navItem{ animation: navIn 420ms var(--ease) forwards; }
    body.menuOpen .navItem:nth-child(1){ animation-delay: 70ms; }
    body.menuOpen .navItem:nth-child(2){ animation-delay: 115ms; }
    body.menuOpen .navItem:nth-child(3){ animation-delay: 160ms; }
    body.menuOpen .navItem:nth-child(4){ animation-delay: 205ms; } /* ✅ added for Music */

    @keyframes navIn{ to{ opacity:1; transform: translateY(0) scale(1); filter: blur(0); } }

    .navItem:hover{
      z-index: 20;
      transform: translateY(-3px) scale(1.02) rotate(-1.5deg);
      border-color: color-mix(in srgb, var(--accent1) 26%, rgba(255,255,255,.14));
      background: rgba(255,255,255,.06);
    }

    .navLeft{ display:flex; align-items:center; gap: 10px; font-size: 13px; }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: linear-gradient(135deg, rgba(255,255,255,.22), color-mix(in srgb, var(--accent1) 86%, #fff0), color-mix(in srgb, var(--accent2) 62%, #fff0));
      box-shadow: 0 0 calc(20px * var(--glow)) color-mix(in srgb, var(--accent1) 26%, transparent);
    }
    .chev{ opacity:.65; }

    .drawerFoot{
      margin-top:auto; padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.62);
      font-size: 12px;
      line-height: 1.35;
      padding: 0 10px 6px;
    }

    .stage{
      position:relative;
      z-index: 10;
      height:100%;
      width:100%;
      padding: 16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }

    .hero{
      text-align:center;
      opacity:0;
      transform: translateY(10px);
      filter: blur(10px);
      animation: heroIn 720ms var(--ease) forwards 120ms;
    }
    @keyframes heroIn{ to{ opacity:1; transform: translateY(0); filter: blur(0);} }

    .waveTitle{
      display:inline-flex;
      gap: 2px;
      font-weight: 900;
      letter-spacing: -2px;
      font-size: clamp(60px, 9vw, 132px);
      line-height: 1;
      color: rgba(255,255,255,.46);
      text-shadow:
        0 0 calc(40px * var(--glow)) color-mix(in srgb, var(--accent1) 16%, transparent),
        0 0 calc(90px * var(--glow)) color-mix(in srgb, var(--accent1) 10%, transparent);
      user-select:none;
    }
    .waveTitle span{
      display:inline-block;
      animation: wave 1400ms ease-in-out infinite;
      animation-delay: calc(var(--i) * 70ms);
    }
    @keyframes wave{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(calc(-10px * var(--motion))); }
    }

    .subtitle{
      margin-top: 10px;
      color: rgba(255,255,255,.66);
      font-size: 13px;
      letter-spacing:.2px;
    }

    .clockPill{
      margin: 16px auto 0;
      display:inline-flex;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      -webkit-backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      box-shadow: 0 18px 48px rgba(0,0,0,.26), 0 0 calc(60px * var(--glow)) color-mix(in srgb, var(--accent1) 12%, transparent);
      cursor:pointer;
      user-select:none;
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease);
    }
    .clockPill:hover{
      transform: translateY(-2px) rotate(-1.4deg) scale(1.02);
      border-color: color-mix(in srgb, var(--accent1) 30%, rgba(255,255,255,.14));
    }
    .clockDot{
      width: 10px; height: 10px; border-radius: 999px;
      background: color-mix(in srgb, var(--accent1) 80%, white);
      box-shadow: 0 0 calc(24px * var(--glow)) color-mix(in srgb, var(--accent1) 30%, transparent);
    }
    .clockText{ font-size: 12px; color: rgba(255,255,255,.86); }
    .clockHint{ font-size: 12px; color: rgba(255,255,255,.55); }

    .settingsScrim{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.58);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--speed) var(--ease);
      z-index: 9998;
    }
    .settingsWin{
      position: fixed;
      left: 50%;
      top: 52%;
      transform: translate(-50%, -50%) scale(.96);
      width: min(980px, 92vw);
      height: min(720px, 84vh);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      -webkit-backdrop-filter: blur(var(--blur)) saturate(var(--sat));
      box-shadow:
        0 38px 120px rgba(0,0,0,.62),
        0 0 calc(110px * var(--glow)) color-mix(in srgb, var(--accent1) 18%, transparent);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--speed) var(--ease), transform var(--speed) var(--ease);
      z-index: 9999;
      overflow: hidden;
    }
    body.settingsOpen .settingsScrim{ opacity: 1; pointer-events: auto; }
    body.settingsOpen .settingsWin{ opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

    .settingsWin::before{
      content:"";
      position:absolute; inset:-60%;
      background: conic-gradient(from 120deg,
        color-mix(in srgb, var(--accent1) 42%, transparent),
        color-mix(in srgb, var(--accent2) 22%, transparent),
        color-mix(in srgb, var(--accent3) 18%, transparent),
        color-mix(in srgb, var(--accent1) 42%, transparent)
      );
      filter: blur(22px) saturate(190%);
      opacity: .55;
      pointer-events:none;
    }

    .settingsInner{
      position: relative;
      height: 100%;
      display: grid;
      grid-template-rows: 64px 1fr;
    }

    .settingsTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .settingsTitle{ display:flex; flex-direction:column; gap:2px; }
    .settingsTitle strong{ font-size: 14px; letter-spacing:.2px; }
    .settingsTitle span{ font-size: 12px; color: rgba(255,255,255,.68); }

    .xBtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease), background var(--speed) var(--ease);
    }
    .xBtn:hover{
      transform: translateY(-1px) rotate(-4deg) scale(1.03);
      border-color: color-mix(in srgb, var(--accent1) 38%, rgba(255,255,255,.14));
      background: color-mix(in srgb, var(--accent1) 14%, rgba(0,0,0,.10));
    }

    .settingsBody{
      padding: 16px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      overflow: hidden;
    }

    .panel2{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
      box-shadow: 0 24px 70px rgba(0,0,0,.30);
      overflow: hidden;
    }

    .themesPanel{ padding: 14px; display:flex; flex-direction:column; gap: 10px; min-width: 0; }
    .themesHead{ display:flex; align-items:flex-end; justify-content:space-between; gap: 10px; }
    .themesHead h3{ font-size: 13px; letter-spacing:.2px; margin: 0; }
    .themesHead p{ margin: 0; font-size: 12px; color: rgba(255,255,255,.62); }

    .themeGrid{
      margin-top: 8px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      overflow:auto;
      padding-right: 6px;
      max-height: calc(100% - 56px);
    }
    .themeGrid::-webkit-scrollbar{ width: 12px; }
    .themeGrid::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border: 3px solid rgba(0,0,0,0);
      background-clip: padding-box;
      border-radius: 999px;
    }

    .themeCard{
      position: relative;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      cursor:pointer;
      min-height: 128px;
      padding: 12px;
      transform: perspective(900px) translateY(10px) scale(.92) rotateX(6deg);
      opacity: 0;
      filter: blur(10px);
      animation: themeIn 720ms var(--ease) forwards;
      animation-delay: calc(var(--d,0) * 70ms + 120ms);
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease), box-shadow var(--speed) var(--ease), background var(--speed) var(--ease);
      user-select:none;
    }
    @keyframes themeIn{
      0%   { opacity:0; transform: perspective(900px) translateY(18px) scale(.86) rotateX(10deg); filter: blur(12px); }
      60%  { opacity:1; transform: perspective(900px) translateY(-6px) scale(1.06) rotateX(0deg); filter: blur(0); }
      100% { opacity:1; transform: perspective(900px) translateY(0px) scale(1) rotateX(0deg); filter: blur(0); }
    }
    .themeCard::before{
      content:"";
      position:absolute; inset:-60%;
      background:
        radial-gradient(420px 240px at 30% 30%, var(--tA), transparent 60%),
        radial-gradient(460px 260px at 75% 35%, var(--tB), transparent 60%),
        radial-gradient(520px 300px at 50% 85%, var(--tC), transparent 65%);
      filter: blur(18px) saturate(190%);
      opacity: .85;
      pointer-events:none;
    }
    .themeCard::after{
      content:"";
      position:absolute; inset:0;
      border-radius: 20px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: .42;
      pointer-events:none;
    }
    .themeMeta{ position: relative; z-index: 2; display:flex; flex-direction:column; gap: 6px; }
    .themeMeta strong{ font-size: 13px; letter-spacing:.2px; display:flex; align-items:center; justify-content:space-between; gap: 8px; }
    .themeMeta span{ font-size: 12px; color: rgba(255,255,255,.70); line-height: 1.25; }

    .selectedPill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      color: rgba(255,255,255,.78);
      font-size: 11px;
      display:none;
    }
    .themeCard[data-selected="1"] .selectedPill{ display:inline-block; }

    .themeCard:hover{
      z-index: 50;
      border-color: color-mix(in srgb, var(--tA) 48%, rgba(255,255,255,.18));
      background: rgba(255,255,255,.08);
      transform: perspective(900px) translateY(-10px) scale(1.06) rotateZ(-2.2deg);
      box-shadow:
        0 38px 120px rgba(0,0,0,.50),
        0 0 calc(84px * var(--glow)) color-mix(in srgb, var(--tA) 24%, transparent);
    }
    .themeCard:active{
      transform: perspective(900px) translateY(-6px) scale(1.03) rotateZ(1.2deg);
    }

    .controlsPanel{ padding: 14px; display:flex; flex-direction:column; gap: 12px; overflow:auto; }
    .controlsPanel::-webkit-scrollbar{ width: 12px; }
    .controlsPanel::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border: 3px solid rgba(0,0,0,0);
      background-clip: padding-box;
      border-radius: 999px;
    }

    .controlRow{
      display:flex; flex-direction:column; gap: 6px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.08);
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease);
    }
    .controlRow:hover{
      transform: translateY(-3px) rotate(-1deg);
      border-color: color-mix(in srgb, var(--accent1) 30%, rgba(255,255,255,.14));
    }
    .controlRow label{
      font-size: 12px;
      color: rgba(255,255,255,.85);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .controlRow small{ color: rgba(255,255,255,.62); font-size: 11px; }

    input[type="range"]{ width:100%; accent-color: var(--accent1); cursor:pointer; }

    .btnRow{ display:flex; gap: 10px; }
    .btn2{
      flex:1;
      height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.90);
      cursor:pointer;
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease), background var(--speed) var(--ease);
      user-select:none;
    }
    .btn2:hover{
      transform: translateY(-2px) rotate(-1deg) scale(1.02);
      border-color: color-mix(in srgb, var(--accent1) 36%, rgba(255,255,255,.14));
      background: color-mix(in srgb, var(--accent1) 14%, rgba(255,255,255,.08));
    }
    .btn2:active{ transform: translateY(0px) scale(.99) rotate(1deg); }

    .customPanelTitle{
      margin-top: 2px;
      font-size: 12px;
      color: rgba(255,255,255,.80);
      letter-spacing:.2px;
    }
    .customGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    .pick{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.07);
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease);
    }
    .pick:hover{
      transform: translateY(-2px) rotate(-.8deg);
      border-color: color-mix(in srgb, var(--accent1) 28%, rgba(255,255,255,.14));
    }
    .pick label{
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
    .colorInput{
      width: 42px;
      height: 32px;
      padding: 0;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    .colorInput::-webkit-color-swatch-wrapper{ padding:0; }
    .colorInput::-webkit-color-swatch{
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
    }

    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.07);
      transition: transform var(--speed) var(--ease), border-color var(--speed) var(--ease);
    }
    .toggleRow:hover{
      transform: translateY(-2px) rotate(-.8deg);
      border-color: color-mix(in srgb, var(--accent1) 28%, rgba(255,255,255,.14));
    }
    .toggleRow span{
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }

    .switch{
      width: 48px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      position: relative;
      cursor: pointer;
      transition: background var(--speed) var(--ease), border-color var(--speed) var(--ease);
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      width: 22px;
      height: 22px;
      top: 2px;
      left: 2px;
      border-radius: 999px;
      background: rgba(255,255,255,.86);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      transition: transform var(--speed) var(--ease), background var(--speed) var(--ease);
    }
    .switch.on{
      background: color-mix(in srgb, var(--accent1) 20%, rgba(255,255,255,.08));
      border-color: color-mix(in srgb, var(--accent1) 35%, rgba(255,255,255,.16));
    }
    .switch.on::after{
      transform: translateX(20px);
      background: color-mix(in srgb, var(--accent1) 60%, rgba(255,255,255,.92));
    }

    @media (max-width: 900px){
      .settingsBody{ grid-template-columns: 1fr; }
      .themeGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .drawer{ width: 86vw; }
      .customGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="grid"></div>
  <div class="cursorGlow"></div>
  <div class="grain"></div>
  <canvas id="particles"></canvas>

  <button class="hamburger" id="menuBtn" aria-label="Open menu" title="Menu">
    <div class="lines" aria-hidden="true"><span></span><span></span><span></span></div>
  </button>

  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="Sidebar">
    <div class="drawerInner">
      <div class="drawerTop">
        <div class="brand">
          <strong>AMETHYST</strong>
          <span>Crystal</span>
        </div>
        <button class="close" id="closeBtn">Close</button>
      </div>

      <div class="nav">
        <div class="navItem" data-action="home">
          <div class="navLeft"><span class="dot"></span> Home</div><div class="chev">›</div>
        </div>
        <div class="navItem" data-action="goto" data-href="g.html">
          <div class="navLeft"><span class="dot"></span> Games</div><div class="chev">›</div>
        </div>
        
                <div class="navItem" data-action="goto" data-href="apps.html">
          <div class="navLeft"><span class="dot"></span> Apps</div><div class="chev">›</div>
        </div>

        <div class="navItem" data-action="goto" data-href="music.html">
          <div class="navLeft"><span class="dot"></span> Music</div><div class="chev">›</div>
        </div>

        <div class="navItem" data-action="settings">
          <div class="navLeft"><span class="dot"></span> Settings</div><div class="chev">›</div>
        </div>
      </div>

      <div class="drawerFoot">
        Burger
        <br/>Bacon egg and <b>Cheese</b>
      </div>
    </div>
  </aside>

  <main class="stage" id="home">
    <div class="hero">
      <div class="waveTitle" aria-label="AMETHYST">
        <span style="--i:0">A</span><span style="--i:1">M</span><span style="--i:2">E</span><span style="--i:3">T</span>
        <span style="--i:4">H</span><span style="--i:5">Y</span><span style="--i:6">S</span><span style="--i:7">T</span>
      </div>
      <div class="subtitle">Water • Fire • Earth • Amethyst</div>

      <div class="clockPill" id="clockPill" title="Click to change format">
        <div class="clockDot"></div>
        <div class="clockText" id="clockText">--:--</div>
        <div class="clockHint" id="clockHint">click • 12h</div>
      </div>
    </div>
  </main>

  <div class="settingsScrim" id="settingsScrim"></div>
  <section class="settingsWin" id="settingsWin" aria-label="Settings">
    <div class="settingsInner">
      <header class="settingsTop">
        <div class="settingsTitle">
          <strong>Settings</strong>
          <span>themes</span>
        </div>
        <button class="xBtn" id="settingsClose" aria-label="Close settings">✕</button>
      </header>

      <div class="settingsBody">

        <div class="panel2 themesPanel">
          <div class="themesHead">
            <div>
              <h3>Themes</h3>
              <p>ur on the main page</p>
            </div>
            <p id="themeCount"></p>
          </div>

          <div class="themeGrid" id="themeGrid"></div>
        </div>

        <div class="panel2 controlsPanel">
          <div class="controlRow">
            <label>Glow <span id="glowVal">1.00</span></label>
            <input id="glowRange" type="range" min="0.6" max="1.6" step="0.02" value="1">
            <small>More bright</small>
          </div>

          <div class="controlRow">
            <label>Motion <span id="motionVal">1.00</span></label>
            <input id="motionRange" type="range" min="0" max="1" step="0.05" value="1">
            <small>Movement</small>
          </div>

          <div class="controlRow" style="gap:10px;">
            <div class="customPanelTitle"><b>Make your own theme</b></div>

            <div class="customGrid">
              <div class="pick">
                <label>Accent 1</label>
                <input class="colorInput" id="cA1" type="color" value="#c88bff">
              </div>
              <div class="pick">
                <label>Accent 2</label>
                <input class="colorInput" id="cA2" type="color" value="#a86cff">
              </div>

              <div class="pick">
                <label>Accent 3</label>
                <input class="colorInput" id="cA3" type="color" value="#8c4cff">
              </div>
              <div class="pick">
                <label>Gradient Angle</label>
                <input id="gradAngle" type="range" min="0" max="360" step="1" value="180" />
              </div>

              <div class="pick">
                <label>BG A</label>
                <input class="colorInput" id="cBG1" type="color" value="#050112">
              </div>
              <div class="pick">
                <label>BG B</label>
                <input class="colorInput" id="cBG2" type="color" value="#08021b">
              </div>

              <div class="pick">
                <label>BG C</label>
                <input class="colorInput" id="cBG3" type="color" value="#120433">
              </div>
              <div class="pick">
                <label>Particles Density</label>
                <input id="pDensity" type="range" min="0" max="220" step="5" value="120" />
              </div>
            </div>

            <div class="toggleRow">
              <span>Particles</span>
              <div class="switch" id="pToggle" role="switch" aria-checked="false"></div>
            </div>

            <div class="btnRow" style="margin-top:0;">
              <button class="btn2" id="saveCustomBtn">Save Custom</button>
              <button class="btn2" id="useCustomBtn">Use Custom</button>
            </div>

            <div class="btnRow" style="margin-top:0;">
              <button class="btn2" id="clearCustomBtn">Clear Custom</button>
              <button class="btn2" id="randomCustomBtn">Randomize</button>
            </div>
          </div>

          <div class="btnRow">
            <button class="btn2" id="resetThemeBtn">Reset</button>
            <button class="btn2" id="randomThemeBtn">Random</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>

    const root = document.documentElement;
    let raf = 0, nx = innerWidth/2, ny = innerHeight/2;
    function schedule(){
      if (raf) return;
      raf = requestAnimationFrame(()=>{
        raf = 0;
        root.style.setProperty("--mx", nx + "px");
        root.style.setProperty("--my", ny + "px");
      });
    }
    addEventListener("mousemove", (e)=>{ nx=e.clientX; ny=e.clientY; schedule(); }, {passive:true});
    addEventListener("touchmove", (e)=>{ nx=e.touches[0].clientX; ny=e.touches[0].clientY; schedule(); }, {passive:true});

    const menuBtn = document.getElementById("menuBtn");
    const scrim = document.getElementById("scrim");
    const closeBtn = document.getElementById("closeBtn");
    const drawer = document.getElementById("drawer");

    function openMenu(){ document.body.classList.add("menuOpen"); }
    function closeMenu(){ document.body.classList.remove("menuOpen"); }
    function toggleMenu(){ document.body.classList.contains("menuOpen") ? closeMenu() : openMenu(); }

    menuBtn.addEventListener("click", toggleMenu);
    scrim.addEventListener("click", closeMenu);
    closeBtn.addEventListener("click", closeMenu);

    menuBtn.addEventListener("mouseenter", ()=> openMenu());
    drawer.addEventListener("mouseleave", ()=> closeMenu());

    addEventListener("keydown", (e)=>{
      if (e.key === "Escape"){
        closeMenu();
        closeSettings();
      }
    });

    const clockText = document.getElementById("clockText");
    const clockHint = document.getElementById("clockHint");
    const clockPill = document.getElementById("clockPill");

    let clockMode = +(localStorage.getItem("amethyst_clock_mode") || "0"); // 0=12h,1=24h,2=date
    function formatClock(){
      const now = new Date();
      if (clockMode === 2){
        const s = now.toLocaleDateString(undefined, {weekday:"short", month:"short", day:"numeric", year:"numeric"});
        clockText.textContent = s;
        clockHint.textContent = "click • date";
        return;
      }
      const opts = { hour:"2-digit", minute:"2-digit", second:"2-digit", hour12: clockMode===0 };
      clockText.textContent = now.toLocaleTimeString(undefined, opts);
      clockHint.textContent = clockMode===0 ? "click • 12h" : "click • 24h";
    }
    setInterval(formatClock, 250);
    formatClock();

    clockPill.addEventListener("click", ()=>{
      clockMode = (clockMode + 1) % 3;
      localStorage.setItem("amethyst_clock_mode", String(clockMode));
      formatClock();
    });

    const settingsScrim = document.getElementById("settingsScrim");
    const settingsClose = document.getElementById("settingsClose");

    function openSettings(){ document.body.classList.add("settingsOpen"); }
    function closeSettings(){ document.body.classList.remove("settingsOpen"); }

    settingsScrim.addEventListener("click", closeSettings);
    settingsClose.addEventListener("click", closeSettings);

    document.querySelectorAll(".navItem").forEach(item=>{
      item.addEventListener("click", ()=>{
        const act = item.dataset.action;

        if (act === "home"){

          document.querySelector(".hero")?.animate(
            [{transform:"translateY(0px)"},{transform:"translateY(-6px)"},{transform:"translateY(0px)"}],
            {duration:260, easing:"cubic-bezier(.18,.98,.22,1)"}
          );
        }

        if (act === "goto"){
          const href = (item.dataset.href || "").trim();
          if (href && !/^https?:\/\//i.test(href)) window.location.href = href;
        }

        if (act === "settings"){
          openSettings();
        }

        closeMenu();
      });
    });

    const THEMES = [
      { id:"amethyst", name:"Amethyst",     bgA:"#050112", bgB:"#08021b", bgC:"#120433", a1:"#c88bff", a2:"#a86cff", a3:"#8c4cff", angle:180 },
      { id:"prism",   name:"Prism Bloom",  bgA:"#03010b", bgB:"#07021a", bgC:"#14003b", a1:"#ff78ff", a2:"#6bdbff", a3:"#a8ff6b", angle:200 },
      { id:"nebula",  name:"Nebula",       bgA:"#040014", bgB:"#0a0430", bgC:"#1b0654", a1:"#b58cff", a2:"#67b7ff", a3:"#ff70e6", angle:180 },
      { id:"violet",  name:"Violet Glass", bgA:"#040012", bgB:"#090222", bgC:"#15043a", a1:"#d1a2ff", a2:"#9b7cff", a3:"#6ee7ff", angle:190 },
      { id:"miku",    name:"Miku Neon",    bgA:"#021014", bgB:"#02202a", bgC:"#021a2f", a1:"#2dffdd", a2:"#00c6ff", a3:"#a86cff", angle:180 },
      { id:"galaxy",  name:"Galaxy",       bgA:"#040014", bgB:"#0a0435", bgC:"#020717", a1:"#a86cff", a2:"#5bd0ff", a3:"#ff7adf", angle:180 },
      { id:"ruby",    name:"Ruby Glow",    bgA:"#120005", bgB:"#24000c", bgC:"#070012", a1:"#ff4d8d", a2:"#ff7a5c", a3:"#c88bff", angle:180 },
      { id:"aurora",  name:"Aurora",       bgA:"#001013", bgB:"#001a22", bgC:"#070018", a1:"#00ffa3", a2:"#00c6ff", a3:"#c88bff", angle:180 },
      { id:"ice",     name:"Ice Prism",    bgA:"#010912", bgB:"#041426", bgC:"#020010", a1:"#7be7ff", a2:"#b58cff", a3:"#ffffff", angle:180 },
      { id:"gold",    name:"Gold Lux",     bgA:"#0c0700", bgB:"#160c00", bgC:"#0a0012", a1:"#ffd36a", a2:"#ff9a3d", a3:"#c88bff", angle:180 },
      { id:"toxic",   name:"Toxic Pop",    bgA:"#020b06", bgB:"#03110b", bgC:"#100038", a1:"#b6ff3b", a2:"#00ffa3", a3:"#ff78ff", angle:180 },
      { id:"mono",    name:"Mono Glass",   bgA:"#05060a", bgB:"#0a0c12", bgC:"#02030a", a1:"#e8e8ff", a2:"#b9c4ff", a3:"#8c4cff", angle:180 },
      { id:"rose",    name:"Rose Prism",   bgA:"#090012", bgB:"#180024", bgC:"#040012", a1:"#ff6bcb", a2:"#c88bff", a3:"#6bdbff", angle:180 },
      { id:"mint",    name:"Mint Glass",   bgA:"#001214", bgB:"#00242a", bgC:"#040012", a1:"#7affd8", a2:"#6bdbff", a3:"#c88bff", angle:180 }
    ];

    const themeGrid = document.getElementById("themeGrid");
    const themeCount = document.getElementById("themeCount");

    function setSelected(id){
      document.querySelectorAll(".themeCard").forEach(c=>{
        c.dataset.selected = (c.dataset.id === id) ? "1" : "0";
      });
    }

    function applyTheme(t){
      root.style.setProperty("--bgA", t.bgA);
      root.style.setProperty("--bgB", t.bgB);
      root.style.setProperty("--bgC", t.bgC);
      root.style.setProperty("--bgAngle", (t.angle ?? 180) + "deg");

      root.style.setProperty("--accent1", t.a1);
      root.style.setProperty("--accent2", t.a2);
      root.style.setProperty("--accent3", t.a3);

      localStorage.setItem("amethyst_theme", t.id);
      setSelected(t.id);
    }

    function loadTheme(){
      const saved = localStorage.getItem("amethyst_theme") || "amethyst";
      if (saved === "custom"){

        setSelected("__none__");
        return;
      }
      const t = THEMES.find(x=>x.id===saved) || THEMES[0];
      applyTheme(t);
    }

    function renderThemes(){
      themeGrid.innerHTML = "";
      THEMES.forEach((t, i)=>{
        const card = document.createElement("div");
        card.className = "themeCard";
        card.style.setProperty("--d", i);
        card.dataset.id = t.id;

        card.style.setProperty("--tA", t.a1 + "66");
        card.style.setProperty("--tB", t.a2 + "55");
        card.style.setProperty("--tC", t.a3 + "55");

        card.innerHTML = `
          <div class="themeMeta">
            <strong>${t.name}<span class="selectedPill">Selected</span></strong>
            <span>${t.id}</span>
          </div>
        `;

        card.addEventListener("click", ()=>{
          card.animate([
            { transform: "perspective(900px) translateY(-10px) scale(1.06) rotateZ(0deg)" },
            { transform: "perspective(900px) translateY(-10px) scale(1.06) rotateZ(3deg)" },
            { transform: "perspective(900px) translateY(-10px) scale(1.06) rotateZ(-3deg)" },
            { transform: "perspective(900px) translateY(-10px) scale(1.06) rotateZ(0deg)" }
          ], { duration: 360, easing: "cubic-bezier(.18,.98,.22,1)" });

          applyTheme(t);
        });

        card.addEventListener("mousemove", (e)=>{
          const r = card.getBoundingClientRect();
          const x = (e.clientX - r.left) / r.width;
          const y = (e.clientY - r.top) / r.height;

          const mx = (x - 0.5) * 2;
          const my = (y - 0.5) * 2;

          const motion = parseFloat(getComputedStyle(root).getPropertyValue("--motion")) || 1;
          const rx = (-my * 10) * motion;
          const ry = ( mx * 12) * motion;
          const rz = (-mx * 3) * motion;

          card.style.transform =
            `perspective(900px) translateY(-10px) scale(1.06) rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg)`;
        }, {passive:true});

        card.addEventListener("mouseleave", ()=>{ card.style.transform = ""; });

        themeGrid.appendChild(card);
      });

      themeCount.textContent = `${THEMES.length} themes`;
      setSelected(localStorage.getItem("amethyst_theme") || "amethyst");
    }

    const glowRange = document.getElementById("glowRange");
    const motionRange = document.getElementById("motionRange");
    const glowVal = document.getElementById("glowVal");
    const motionVal = document.getElementById("motionVal");

    function setGlow(v){
      root.style.setProperty("--glow", v);
      glowVal.textContent = (+v).toFixed(2);
      localStorage.setItem("amethyst_glow", v);
    }
    function setMotion(v){
      root.style.setProperty("--motion", v);
      motionVal.textContent = (+v).toFixed(2);
      localStorage.setItem("amethyst_motion", v);
    }
    function loadControls(){
      const g = localStorage.getItem("amethyst_glow") || "1";
      const m = localStorage.getItem("amethyst_motion") || "1";
      glowRange.value = g; motionRange.value = m;
      setGlow(g); setMotion(m);
    }
    glowRange.addEventListener("input", e=> setGlow(e.target.value));
    motionRange.addEventListener("input", e=> setMotion(e.target.value));

    document.getElementById("resetThemeBtn").addEventListener("click", ()=>{
      localStorage.removeItem("amethyst_theme");
      localStorage.removeItem("amethyst_glow");
      localStorage.removeItem("amethyst_motion");
      localStorage.removeItem("amethyst_custom_theme");
      localStorage.removeItem("amethyst_grad_angle");
      loadControls();
      applyTheme(THEMES[0]);
      setSwitch(pToggle, false);
      localStorage.setItem("amethyst_particles", "0");
      stopParticles();
    });

    document.getElementById("randomThemeBtn").addEventListener("click", ()=>{
      const t = THEMES[Math.floor(Math.random()*THEMES.length)];
      applyTheme(t);
    });

    const CUSTOM_KEY = "amethyst_custom_theme";
    const PARTICLE_KEY = "amethyst_particles";
    const PARTICLE_DENSITY_KEY = "amethyst_particles_density";
    const GRAD_ANGLE_KEY = "amethyst_grad_angle";

    const cA1 = document.getElementById("cA1");
    const cA2 = document.getElementById("cA2");
    const cA3 = document.getElementById("cA3");
    const cBG1 = document.getElementById("cBG1");
    const cBG2 = document.getElementById("cBG2");
    const cBG3 = document.getElementById("cBG3");
    const gradAngle = document.getElementById("gradAngle");
    const pDensity = document.getElementById("pDensity");
    const pToggle = document.getElementById("pToggle");

    const saveCustomBtn = document.getElementById("saveCustomBtn");
    const useCustomBtn = document.getElementById("useCustomBtn");
    const clearCustomBtn = document.getElementById("clearCustomBtn");
    const randomCustomBtn = document.getElementById("randomCustomBtn");

    function setSwitch(el, on){
      el.classList.toggle("on", !!on);
      el.setAttribute("aria-checked", on ? "true" : "false");
    }

    function getCustomFromInputs(){
      return {
        bgA: cBG1.value,
        bgB: cBG2.value,
        bgC: cBG3.value,
        a1: cA1.value,
        a2: cA2.value,
        a3: cA3.value,
        angle: +gradAngle.value || 180
      };
    }

    function applyCustomTheme(obj){
      if (!obj) return;
      root.style.setProperty("--bgA", obj.bgA);
      root.style.setProperty("--bgB", obj.bgB);
      root.style.setProperty("--bgC", obj.bgC);
      root.style.setProperty("--bgAngle", (obj.angle ?? 180) + "deg");

      root.style.setProperty("--accent1", obj.a1);
      root.style.setProperty("--accent2", obj.a2);
      root.style.setProperty("--accent3", obj.a3);
    }

    function loadCustomToInputs(){
      const raw = localStorage.getItem(CUSTOM_KEY);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        cBG1.value = obj.bgA || cBG1.value;
        cBG2.value = obj.bgB || cBG2.value;
        cBG3.value = obj.bgC || cBG3.value;
        cA1.value = obj.a1 || cA1.value;
        cA2.value = obj.a2 || cA2.value;
        cA3.value = obj.a3 || cA3.value;
        gradAngle.value = (obj.angle ?? 180);
      }catch{}
    }

    function livePreview(){
      const obj = getCustomFromInputs();
      applyCustomTheme(obj);
    }

    [cA1,cA2,cA3,cBG1,cBG2,cBG3].forEach(inp=>{
      inp.addEventListener("input", livePreview, {passive:true});
    });
    gradAngle.addEventListener("input", ()=>{
      localStorage.setItem(GRAD_ANGLE_KEY, gradAngle.value);
      livePreview();
    }, {passive:true});

    saveCustomBtn.addEventListener("click", ()=>{
      const obj = getCustomFromInputs();
      localStorage.setItem(CUSTOM_KEY, JSON.stringify(obj));
      saveCustomBtn.animate([{transform:"scale(1)"},{transform:"scale(1.06) rotate(-1deg)"},{transform:"scale(1)"}],{duration:260,easing:"cubic-bezier(.18,.98,.22,1)"});
    });

    useCustomBtn.addEventListener("click", ()=>{
      const raw = localStorage.getItem(CUSTOM_KEY);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        applyCustomTheme(obj);
        localStorage.setItem("amethyst_theme", "custom");
        setSelected("__none__");
        useCustomBtn.animate([{transform:"scale(1)"},{transform:"scale(1.06) rotate(2deg)"},{transform:"scale(1)"}],{duration:260,easing:"cubic-bezier(.18,.98,.22,1)"});
      }catch{}
    });

    clearCustomBtn.addEventListener("click", ()=>{
      localStorage.removeItem(CUSTOM_KEY);
      clearCustomBtn.animate([{transform:"scale(1)"},{transform:"scale(1.06) rotate(-2deg)"},{transform:"scale(1)"}],{duration:260,easing:"cubic-bezier(.18,.98,.22,1)"});
    });

    function randHex(){
      return "#"+Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,"0");
    }
    function darkHex(){

      const v = Math.floor(Math.random()*0x0FFFFF).toString(16).padStart(6,"0");
      return "#0" + v.slice(1);
    }
    randomCustomBtn.addEventListener("click", ()=>{
      cA1.value = randHex();
      cA2.value = randHex();
      cA3.value = randHex();
      cBG1.value = darkHex();
      cBG2.value = darkHex();
      cBG3.value = darkHex();
      gradAngle.value = Math.floor(Math.random()*361);
      localStorage.setItem(GRAD_ANGLE_KEY, gradAngle.value);
      livePreview();
    });

    const canvas = document.getElementById("particles");
    const ctx = canvas.getContext("2d", { alpha: true });

    let W=0,H=0, particles=[], running=false;

    function resize(){
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      W = canvas.width = Math.floor(innerWidth * dpr);
      H = canvas.height = Math.floor(innerHeight * dpr);
      canvas.style.width = innerWidth + "px";
      canvas.style.height = innerHeight + "px";
      canvas.dataset.dpr = dpr;
    }
    addEventListener("resize", resize);
    resize();

    function makeParticles(count){
      const dpr = +canvas.dataset.dpr || 1;
      particles = [];
      for(let i=0;i<count;i++){
        particles.push({
          x: Math.random()*W,
          y: Math.random()*H,
          r: (Math.random()*2.2 + .6) * dpr,
          vx: (Math.random()-.5) * 0.18 * dpr,
          vy: (Math.random()-.5) * 0.18 * dpr,
          a: Math.random()*0.6 + 0.25
        });
      }
    }

    function draw(){
      if (!running) return;

      ctx.clearRect(0,0,W,H);

      const a1 = getComputedStyle(root).getPropertyValue("--accent1").trim() || "#c88bff";
      const a2 = getComputedStyle(root).getPropertyValue("--accent2").trim() || "#a86cff";

      for(const p of particles){
        p.x += p.vx;
        p.y += p.vy;

        if (p.x < -30) p.x = W+30;
        if (p.x > W+30) p.x = -30;
        if (p.y < -30) p.y = H+30;
        if (p.y > H+30) p.y = -30;

        const mx = (parseFloat(getComputedStyle(root).getPropertyValue("--mx")) || innerWidth/2) * (+canvas.dataset.dpr || 1);
        const my = (parseFloat(getComputedStyle(root).getPropertyValue("--my")) || innerHeight/2) * (+canvas.dataset.dpr || 1);
        const dx = mx - p.x, dy = my - p.y;
        const dist = Math.max(120*(+canvas.dataset.dpr||1), Math.hypot(dx,dy));
        const pull = 0.0006;
        p.vx += (dx/dist) * pull;
        p.vy += (dy/dist) * pull;

        const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r*6);
        g.addColorStop(0, a1 + "55");
        g.addColorStop(0.6, a2 + "22");
        g.addColorStop(1, "transparent");

        ctx.fillStyle = g;
        ctx.globalAlpha = p.a;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r*4, 0, Math.PI*2);
        ctx.fill();
      }

      ctx.globalAlpha = 1;
      requestAnimationFrame(draw);
    }

    function startParticles(){
      running = true;
      canvas.style.display = "block";
      const density = +localStorage.getItem(PARTICLE_DENSITY_KEY) || +pDensity.value || 120;
      makeParticles(Math.floor(density));
      draw();
    }

    function stopParticles(){
      running = false;
      canvas.style.display = "none";
      ctx.clearRect(0,0,W,H);
    }

    pToggle.addEventListener("click", ()=>{
      const on = !pToggle.classList.contains("on");
      setSwitch(pToggle, on);
      localStorage.setItem(PARTICLE_KEY, on ? "1" : "0");
      on ? startParticles() : stopParticles();
    });

    pDensity.addEventListener("input", ()=>{
      localStorage.setItem(PARTICLE_DENSITY_KEY, pDensity.value);
      if (running) startParticles();
    }, {passive:true});

    (function init(){
      loadControls();
      renderThemes();
      loadTheme();

      loadCustomToInputs();

      const savedAngle = localStorage.getItem(GRAD_ANGLE_KEY);
      if (savedAngle) gradAngle.value = savedAngle;

      const pOn = (localStorage.getItem(PARTICLE_KEY) || "0") === "1";
      setSwitch(pToggle, pOn);

      const dens = localStorage.getItem(PARTICLE_DENSITY_KEY);
      if (dens) pDensity.value = dens;

      const currentTheme = localStorage.getItem("amethyst_theme");
      if (currentTheme === "custom"){
        const raw = localStorage.getItem(CUSTOM_KEY);
        if (raw){
          try{ applyCustomTheme(JSON.parse(raw)); }catch{}
        }
      }

      if (pOn) startParticles();
    })();

    window.openSettings = openSettings;
  </script>
</body>
</html>
